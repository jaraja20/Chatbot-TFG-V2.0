<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AnÃ¡lisis de Conversaciones</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>
    <!-- NavegaciÃ³n -->
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">ğŸ“Š Sistema de GestiÃ³n de Turnos</h1>
            <div class="nav-links">
                <a href="/" class="nav-link">ğŸ’¬ Chat</a>
                <a href="/dashboard" class="nav-link active">ğŸ“Š Dashboard</a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h2>Dashboard de Aprendizaje</h2>
            <p class="subtitle">AnÃ¡lisis de conversaciones y feedback</p>
            <button id="refreshBtn" class="btn-refresh">ğŸ”„ Actualizar</button>
        </div>

        <!-- EstadÃ­sticas Generales -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-content">
                    <h3 id="totalFeedback">0</h3>
                    <p>Total Feedback</p>
                </div>
            </div>

            <div class="stat-card positive">
                <div class="stat-icon">ğŸ‘</div>
                <div class="stat-content">
                    <h3 id="positiveFeedback">0</h3>
                    <p>Feedback Positivo</p>
                </div>
            </div>

            <div class="stat-card negative">
                <div class="stat-icon">ğŸ‘</div>
                <div class="stat-content">
                    <h3 id="negativeFeedback">0</h3>
                    <p>Feedback Negativo</p>
                </div>
            </div>

            <div class="stat-card satisfaction">
                <div class="stat-icon">ğŸ˜Š</div>
                <div class="stat-content">
                    <h3 id="satisfactionRate">0%</h3>
                    <p>Tasa de SatisfacciÃ³n</p>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="negative">ğŸ‘ Feedback Negativo</button>
            <button class="tab-btn" data-tab="conversations">ğŸ’¬ Conversaciones Recientes</button>
            <button class="tab-btn" data-tab="corrections">ğŸ§  Correcciones</button>
        </div>

        <!-- Contenido de Tabs -->
        <div class="tab-content">
            <!-- Tab: Feedback Negativo -->
            <div class="tab-panel active" id="negative-panel">
                <div class="panel-header">
                    <h3>Feedback Negativo con Comentarios</h3>
                    <p class="help-text">Analiza los comentarios para mejorar el bot</p>
                </div>
                <div id="negativeFeedbackList" class="feedback-list">
                    <!-- Se llenarÃ¡ dinÃ¡micamente -->
                    <div class="loading">Cargando feedback...</div>
                </div>
            </div>
            
            <!-- Tab: Correcciones -->
            <div class="tab-panel" id="corrections-panel">
                <div class="panel-header">
                    <h3>ğŸ§  Correcciones de Usuario</h3>
                    <p class="help-text">Mensajes donde los usuarios corrigieron manualmente al bot</p>
                </div>
                <div id="correctionsList" class="corrections-list">
                    <div class="loading">Cargando correcciones...</div>
                </div>
            </div>


            <!-- Tab: Conversaciones -->
            <div class="tab-panel" id="conversations-panel">
                <div class="panel-header">
                    <h3>Conversaciones Recientes</h3>
                    <p class="help-text">Ãšltimas 20 interacciones</p>
                </div>
                <div id="conversationsList" class="conversations-list">
                    <!-- Se llenarÃ¡ dinÃ¡micamente -->
                    <div class="loading">Cargando conversaciones...</div>
                </div>
            </div>
        </div>

        <!-- =====================================================
             âœ… NUEVA SECCIÃ“N: ANÃLISIS AVANZADO
             ===================================================== -->
        <div class="advanced-analytics">
            <h2 class="section-title">ğŸ“Š AnÃ¡lisis Avanzado</h2>
            
            <!-- GrÃ¡fico principal: Feedback en el tiempo -->
            <div class="chart-card large">
                <h3>ğŸ“ˆ Tendencia de Feedback (Ãšltimos 7 dÃ­as)</h3>
                <canvas id="feedbackTimeChart"></canvas>
            </div>
            
            <!-- Grid de 2 grÃ¡ficos -->
            <div class="charts-grid-2">
                <!-- Intents mÃ¡s comunes -->
                <div class="chart-card">
                    <h3>ğŸ¯ Top 10 Intents Detectados</h3>
                    <canvas id="intentsChart"></canvas>
                </div>
                
                <!-- Mensajes por hora -->
                <div class="chart-card">
                    <h3>ğŸ• Actividad por Hora</h3>
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
            
            <!-- EstadÃ­sticas de confianza -->
            <div class="stats-cards">
                <div class="stat-card-mini">
                    <div class="stat-icon">ğŸ¯</div>
                    <div class="stat-details">
                        <h4>Confianza Promedio</h4>
                        <p id="avgConfidence" class="stat-value">0%</p>
                    </div>
                </div>
                
                <div class="stat-card-mini">
                    <div class="stat-icon">ğŸ“‰</div>
                    <div class="stat-details">
                        <h4>Baja Confianza</h4>
                        <p id="lowConfidenceCount" class="stat-value">0</p>
                    </div>
                </div>
                
                <div class="stat-card-mini">
                    <div class="stat-icon">ğŸ“</div>
                    <div class="stat-details">
                        <h4>Necesitan RevisiÃ³n</h4>
                        <p id="needsReviewCount" class="stat-value">0</p>
                    </div>
                </div>
                
                <div class="stat-card-mini">
                    <div class="stat-icon">ğŸ’¬</div>
                    <div class="stat-details">
                        <h4>Total Mensajes (30d)</h4>
                        <p id="totalMessages" class="stat-value">0</p>
                    </div>
                </div>
            </div>
            
            <!-- Tab de mensajes que necesitan revisiÃ³n -->
            <div class="review-section">
                <h3>âš ï¸ Mensajes que Necesitan RevisiÃ³n</h3>
                <div id="needsReviewList" class="review-list">
                    <div class="loading">Cargando...</div>
                </div>
            </div>
        </div>
        <!-- FIN DE ANÃLISIS AVANZADO -->

    </div>

    <!-- Script dashboard.js original -->
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

    <!-- =====================================================
         âœ… SCRIPTS NUEVOS: Chart.js y funciones de grÃ¡ficos
         ===================================================== -->
    
    <!-- Chart.js desde CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
    // =====================================================
    // HELPER FUNCTION: Escape HTML
    // =====================================================
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    // =====================================================
    // VARIABLES GLOBALES PARA LOS CHARTS
    // =====================================================
    let feedbackTimeChart = null;
    let intentsChart = null;
    let hourlyChart = null;

    // =====================================================
    // CARGAR GRÃFICO DE FEEDBACK EN EL TIEMPO
    // =====================================================
    async function loadFeedbackTimeChart() {
        try {
            const response = await fetch('/api/dashboard/feedback-over-time');
            const data = await response.json();
            
            if (data.success && data.data.length > 0) {
                const ctx = document.getElementById('feedbackTimeChart').getContext('2d');
                
                if (feedbackTimeChart) {
                    feedbackTimeChart.destroy();
                }
                
                feedbackTimeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.data.map(d => {
                            const date = new Date(d.fecha);
                            return date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
                        }),
                        datasets: [
                            {
                                label: 'Positivos ğŸ‘',
                                data: data.data.map(d => d.positivos),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Negativos ğŸ‘',
                                data: data.data.map(d => d.negativos),
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
                
                console.log('âœ… GrÃ¡fico de feedback cargado');
            }
        } catch (error) {
            console.error('Error cargando feedback chart:', error);
        }
    }

    // =====================================================
    // CARGAR GRÃFICO DE INTENTS
    // =====================================================
    async function loadIntentsChart() {
        try {
            const response = await fetch('/api/dashboard/intents-distribution');
            const data = await response.json();
            
            if (data.success && data.data.length > 0) {
                const ctx = document.getElementById('intentsChart').getContext('2d');
                
                if (intentsChart) {
                    intentsChart.destroy();
                }
                
                // Colores para las barras
                const colors = [
                    '#6366f1', '#8b5cf6', '#ec4899', '#f59e0b',
                    '#10b981', '#06b6d4', '#ef4444', '#f97316',
                    '#84cc16', '#14b8a6'
                ];
                
                intentsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.data.map(d => d.intent),
                        datasets: [{
                            label: 'Cantidad',
                            data: data.data.map(d => d.count),
                            backgroundColor: colors,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
                
                console.log('âœ… GrÃ¡fico de intents cargado');
            }
        } catch (error) {
            console.error('Error cargando intents chart:', error);
        }
    }

    // =====================================================
    // CARGAR GRÃFICO DE ACTIVIDAD POR HORA
    // =====================================================
    async function loadHourlyChart() {
        try {
            const response = await fetch('/api/dashboard/messages-per-hour');
            const data = await response.json();
            
            if (data.success && data.data.length > 0) {
                const ctx = document.getElementById('hourlyChart').getContext('2d');
                
                if (hourlyChart) {
                    hourlyChart.destroy();
                }
                
                hourlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.data.map(d => `${d.hora}:00`),
                        datasets: [{
                            label: 'Mensajes',
                            data: data.data.map(d => d.cantidad),
                            backgroundColor: '#6366f1',
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
                
                console.log('âœ… GrÃ¡fico de actividad por hora cargado');
            }
        } catch (error) {
            console.error('Error cargando hourly chart:', error);
        }
    }

    // =====================================================
    // CARGAR ESTADÃSTICAS DE CONFIANZA
    // =====================================================
    async function loadConfidenceStats() {
        try {
            const response = await fetch('/api/dashboard/confidence-stats');
            const data = await response.json();
            
            if (data.success) {
                const stats = data.stats;
                
                document.getElementById('avgConfidence').textContent = 
                    (stats.avg_confidence * 100).toFixed(1) + '%';
                document.getElementById('lowConfidenceCount').textContent = 
                    stats.low_confidence_count;
                document.getElementById('totalMessages').textContent = 
                    stats.total_messages;
                
                console.log('âœ… EstadÃ­sticas de confianza cargadas');
            }
        } catch (error) {
            console.error('Error cargando confidence stats:', error);
        }
    }

    // =====================================================
    // CARGAR MENSAJES QUE NECESITAN REVISIÃ“N
    // =====================================================
    async function loadNeedsReview() {
        try {
            const response = await fetch('/api/dashboard/needs-review');
            const data = await response.json();
            
            const container = document.getElementById('needsReviewList');
            
            // Actualizar contador
            document.getElementById('needsReviewCount').textContent = data.data.length;
            
            if (data.success && data.data.length > 0) {
                container.innerHTML = data.data.map(item => `
                    <div class="review-item">
                        <div class="review-header">
                            <span class="review-date">ğŸ“… ${item.timestamp}</span>
                            <span class="confidence-badge ${item.confidence < 0.5 ? 'low' : 'medium'}">
                                Confianza: ${(item.confidence * 100).toFixed(0)}%
                            </span>
                        </div>
                        <div class="review-content">
                            <div class="review-message user">
                                <strong>Usuario:</strong> ${escapeHtml(item.user_message)}
                            </div>
                            <div class="review-message bot">
                                <strong>Bot:</strong> ${escapeHtml(item.bot_response)}
                            </div>
                            <div class="review-meta">
                                <span class="intent-badge">${item.intent || 'Sin clasificar'}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                console.log(`âœ… ${data.data.length} mensajes para revisar cargados`);
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âœ…</div>
                        <div class="empty-state-text">No hay mensajes para revisar</div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error cargando needs review:', error);
        }
    }

    // =====================================================
    // CARGAR TODOS LOS GRÃFICOS Y STATS
    // =====================================================
    function loadAdvancedAnalytics() {
        console.log('ğŸ“Š Cargando anÃ¡lisis avanzado...');
        
        loadFeedbackTimeChart();
        loadIntentsChart();
        loadHourlyChart();
        loadConfidenceStats();
        loadNeedsReview();
    }

    // =====================================================
    // INICIALIZACIÃ“N - Ejecutar cuando el DOM estÃ© listo
    // =====================================================
    
    // Esperar a que dashboard.js cargue primero
    window.addEventListener('load', function() {
        console.log('ğŸ“Š Iniciando dashboard avanzado...');
        
        // PequeÃ±o delay para asegurar que dashboard.js se ejecutÃ³
        setTimeout(() => {
            loadAdvancedAnalytics();
            
            // Auto-refresh cada 30 segundos
            setInterval(() => {
                console.log('ğŸ”„ Auto-refresh de grÃ¡ficos');
                loadAdvancedAnalytics();
            }, 30000);
        }, 500);
    });

    console.log('ğŸ“Š Dashboard avanzado inicializado');
    </script>

</body>
</html>