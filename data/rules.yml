version: "3.1"
rules:

# ===============================
# SALUDOS Y DESPEDIDAS
# ===============================
- rule: Saludo inicial
  steps:
    - intent: greet
    - action: utter_greet

- rule: Despedida
  steps:
    - intent: goodbye
    - action: utter_goodbye

- rule: Agradecimiento
  steps:
    - intent: agradecimiento
    - action: utter_agradecimiento

- rule: Bot challenge
  steps:
    - intent: bot_challenge
    - action: utter_iamabot

# ===============================
# FLUJO DE AGENDAMIENTO DE TURNOS
# ===============================
- rule: Iniciar formulario de turno
  steps:
    - intent: agendar_turno
    - action: turno_form
    - active_loop: turno_form

- rule: Completar formulario y mostrar confirmación
  condition:
    - active_loop: turno_form
  steps:
    - action: turno_form
    - active_loop: null
    - slot_was_set:
        - requested_slot: null
    - action: action_confirmar_datos_turno

- rule: Confirmar y guardar turno
  steps:
    - action: action_confirmar_datos_turno
    - or:
        - intent: confirmar_turno
        - intent: affirm
    - action: action_guardar_turno

- rule: Solicitar cambio de datos
  steps:
    - action: action_confirmar_datos_turno
    - or:
        - intent: solicitar_cambio_datos
        - intent: deny
    - action: utter_datos_incorrectos
    - action: turno_form
    - active_loop: turno_form

# ===============================
# MOTOR DIFUSO - ÚNICA REGLA
# ===============================
- rule: Activar motor difuso
  steps:
    - intent: frase_ambigua
    - action: action_recomendar_horario_fuzzy

# ===============================
# CONSULTAS - SIN UTTERANCES DUPLICADOS
# ===============================
- rule: Consultar disponibilidad
  steps:
    - intent: consultar_disponibilidad
    - action: action_consultar_disponibilidad

- rule: Consultar turno existente
  steps:
    - intent: consultar_turno
    - action: action_consultar_turno_existente

- rule: Procesar datos completos de turno
  steps:
    - intent: proporcionar_datos_turno
    - action: turno_form
    - active_loop: turno_form

# ===============================
# CANCELACIÓN DE TURNOS
# ===============================
- rule: Cancelar turno
  steps:
    - intent: cancelar_turno
    - action: utter_cancelar_turno

- rule: Cancelar durante formulario
  condition:
    - active_loop: turno_form
  steps:
    - intent: cancelar_turno
    - action: action_deactivate_loop
    - active_loop: null
    - action: utter_cancelar_turno

# ===============================
# CONSULTAS FRECUENTES
# ===============================
- rule: Consultar requisitos generales
  steps:
    - intent: consultar_requisitos
    - action: utter_consultar_requisitos

- rule: Consultar requisitos primera vez
  steps:
    - intent: consultar_requisitos_primera_vez
    - action: utter_consultar_requisitos_primera_vez

- rule: Consultar trámite menor de edad
  steps:
    - intent: consultar_menor_edad
    - action: utter_consultar_menor_edad

- rule: Consultar trámites para extranjeros
  steps:
    - intent: consultar_extranjeros
    - action: utter_consultar_extranjeros

- rule: Consultar necesidad de turno
  steps:
    - intent: consultar_si_necesita_turno
    - action: utter_consultar_si_necesita_turno

- rule: Consultar trámite online
  steps:
    - intent: consultar_tramite_online
    - action: utter_consultar_tramite_online

- rule: Consultar trámite para terceros
  steps:
    - intent: consultar_tramite_para_terceros
    - action: utter_consultar_tramite_para_terceros

- rule: Consultar tolerancia horaria
  steps:
    - intent: consultar_tolerancia_horaria
    - action: utter_consultar_tolerancia_horaria

- rule: Consultar cédulas sin QR
  steps:
    - intent: consultar_sin_qr
    - action: utter_consultar_sin_qr

- rule: Consultar horarios de atención
  steps:
    - intent: consultar_horarios
    - action: utter_consultar_horarios

- rule: Consultar ubicación
  steps:
    - intent: consultar_ubicacion
    - action: utter_consultar_ubicacion

- rule: Consultar costo del trámite
  steps:
    - intent: consultar_costo
    - action: utter_consultar_costo

# ===============================
# SERVICIOS ADICIONALES
# ===============================
- rule: Consultar estado de trámite
  steps:
    - intent: estado_tramite
    - action: utter_estado_tramite

- rule: Ayuda técnica
  steps:
    - intent: ayuda_tecnica
    - action: utter_ayuda_tecnica

- rule: Consultar tiempo de espera actual
  steps:
    - intent: consulta_tiempo_espera
    - action: action_tiempo_espera_actual

- rule: Calcular saturación actual
  steps:
    - intent: calcular_saturacion
    - action: action_calcular_saturacion

# ===============================
# MANEJO DE ESTADOS DE ÁNIMO
# ===============================
- rule: Respuesta a estado positivo
  steps:
    - intent: mood_great
    - action: utter_happy

- rule: Respuesta a estado negativo
  steps:
    - intent: mood_unhappy
    - action: utter_cheer_up
    - action: utter_did_that_help

# ===============================
# FALLBACK Y OUT OF SCOPE
# ===============================
- rule: Respuesta fallback
  steps:
    - intent: nlu_fallback
    - action: utter_default
    - action: utter_rephrase

- rule: Respuesta fuera de alcance
  steps:
    - intent: out_of_scope
    - action: utter_out_of_scope

# ===============================
# REGLAS DE SESIÓN
# ===============================
- rule: Inicialización de sesión
  conversation_start: true
  steps:
    - action: action_session_start

# ===============================
# MANEJO DE INTERRUPCIONES EN FORMULARIO
# ===============================
- rule: Interrupción con frase ambigua durante formulario
  condition:
    - active_loop: turno_form
  steps:
    - intent: frase_ambigua
    - action: action_recomendar_horario_fuzzy
    - action: turno_form

- rule: Interrupción con consulta disponibilidad durante formulario
  condition:
    - active_loop: turno_form
  steps:
    - intent: consultar_disponibilidad
    - action: action_consultar_disponibilidad
    - action: turno_form

- rule: Interrupción con consulta requisitos durante formulario
  condition:
    - active_loop: turno_form
  steps:
    - intent: consultar_requisitos
    - action: utter_consultar_requisitos
    - action: turno_form

- rule: Interrupción con consulta requisitos primera vez durante formulario
  condition:
    - active_loop: turno_form
  steps:
    - intent: consultar_requisitos_primera_vez
    - action: utter_consultar_requisitos_primera_vez
    - action: turno_form

# ===============================
# RESTART CONVERSATION
# ===============================
- rule: Restart conversation
  steps:
    - intent: restart
    - action: action_restart